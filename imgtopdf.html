<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPDF | Smart Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <style>
        .sortable-ghost { opacity: 0.2; border: 2px solid #6366f1; transform: scale(0.9); }
        .image-container { transition: all 0.2s ease; }
        .edit-overlay { opacity: 0; transition: opacity 0.2s; }
        .image-container:hover .edit-overlay { opacity: 1; }
    </style>
</head>
<body class="bg-[#f3f4f6] min-h-screen pb-20">

    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b px-6 py-3 flex justify-between items-center shadow-sm">
        <h1 class="text-xl font-black text-indigo-600">PRO-PDF</h1>
        <div class="flex gap-3">
            <button onclick="document.getElementById('fileInput').click()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg font-bold text-sm">+ Add Images</button>
            <button id="convertBtn" class="hidden bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition-all active:scale-95">Generate PDF</button>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 lg:p-8">
        <div id="emptyState" class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-20 text-center mb-8">
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
            <div class="text-5xl mb-4">ðŸ“¸</div>
            <h2 class="text-xl font-bold text-slate-700">Images Upload Karein</h2>
            <button onclick="document.getElementById('fileInput').click()" class="mt-4 bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold">Files Select Karein</button>
        </div>

        <div class="mb-4 flex items-center justify-between">
            <h3 class="font-bold text-slate-600 uppercase text-xs tracking-widest">Images Arrange Karein (Drag to Reorder) And Click Image To Edit</h3>
            <span id="imgCount" class="text-xs text-slate-400 font-medium">0 images added</span>
        </div>

        <div id="sortableGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
            </div>
    </main>

    <div id="editModal" class="fixed inset-0 bg-slate-900/95 hidden z-[100] flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-4xl overflow-hidden shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <span class="font-bold text-slate-700">Image Editor</span>
                <div class="flex gap-2">
                    <button onclick="applyFilter('grayscale(100%)')" class="px-3 py-1 bg-slate-200 rounded text-xs font-bold">B&W</button>
                    <button onclick="applyFilter('brightness(1.4)')" class="px-3 py-1 bg-slate-200 rounded text-xs font-bold">Brighten</button>
                    <button onclick="applyFilter('none')" class="px-3 py-1 bg-red-100 text-red-600 rounded text-xs font-bold">Reset</button>
                </div>
            </div>
            
            <div class="h-[60vh] bg-slate-100 flex items-center justify-center overflow-hidden">
                <img id="editingImage" class="max-h-full max-w-full">
            </div>

            <div class="p-6 flex justify-between items-center">
                <button onclick="removeCurrentImage()" class="text-red-500 font-bold text-sm">Delete Image</button>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="px-6 py-2 text-slate-500 font-bold">Cancel</button>
                    <button onclick="saveChanges()" class="bg-indigo-600 text-white px-8 py-2 rounded-xl font-bold">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdfModal" class="fixed inset-0 bg-black/90 hidden z-[100] p-4 flex flex-col">
        <div class="flex justify-between p-4 bg-white rounded-t-2xl">
            <h3 class="font-bold">PDF Preview</h3>
            <div class="flex gap-2">
                <a id="downloadBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Download</a>
                <button onclick="location.reload()" class="bg-slate-200 px-4 py-2 rounded-lg text-sm">Close</button>
            </div>
        </div>
        <iframe id="pdfFrame" class="w-full flex-grow bg-white rounded-b-2xl border-none"></iframe>
    </div>

    <script>
        let imageData = [];
        let currentId = null;
        let cropper = null;

        const fileInput = document.getElementById('fileInput');
        const sortableGrid = document.getElementById('sortableGrid');
        const emptyState = document.getElementById('emptyState');
        const convertBtn = document.getElementById('convertBtn');

        // Drag & Drop Setup
        new Sortable(sortableGrid, {
            animation: 250,
            ghostClass: 'sortable-ghost',
            onEnd: () => {
                const newOrder = [];
                document.querySelectorAll('.image-container').forEach(el => {
                    newOrder.push(imageData.find(img => img.id == el.dataset.id));
                });
                imageData = newOrder;
                renderImages();
            }
        });

        fileInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (rs) => {
                    imageData.push({ id: Date.now() + Math.random(), src: rs.target.result, filter: 'none' });
                    renderImages();
                };
                reader.readAsDataURL(file);
            });
            emptyState.classList.add('hidden');
            convertBtn.classList.remove('hidden');
        };

        function renderImages() {
            sortableGrid.innerHTML = '';
            document.getElementById('imgCount').innerText = `${imageData.length} images added`;
            
            imageData.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'image-container relative aspect-square bg-white rounded-xl shadow-sm border overflow-hidden cursor-move group';
                div.dataset.id = img.id;
                div.innerHTML = `
                    <img src="${img.src}" class="w-full h-full object-cover" style="filter: ${img.filter}">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                        <button onclick="openEdit(${img.id})" class="bg-white text-black text-[10px] font-bold px-3 py-1 rounded-full shadow-lg">CLICK TO EDIT</button>
                    </div>
                    <div class="absolute top-1 left-1 bg-indigo-600 text-white text-[9px] w-4 h-4 rounded flex items-center justify-center font-bold shadow">${index + 1}</div>
                `;
                sortableGrid.appendChild(div);
            });
        }

        function openEdit(id) {
            currentId = id;
            const item = imageData.find(i => i.id === id);
            const editModal = document.getElementById('editModal');
            const editingImage = document.getElementById('editingImage');
            
            editingImage.src = item.src;
            editModal.classList.remove('hidden');

            if(cropper) cropper.destroy();
            cropper = new Cropper(editingImage, {
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 1,
                checkOrientation: false
            });
        }

        function applyFilter(f) {
            const canvas = cropper.getCroppedCanvas();
            // Just for UI preview in editor
            document.querySelector('.cropper-container img').style.filter = f;
            const index = imageData.findIndex(i => i.id === currentId);
            imageData[index].filter = f;
        }

        function saveChanges() {
            const canvas = cropper.getCroppedCanvas();
            const index = imageData.findIndex(i => i.id === currentId);
            imageData[index].src = canvas.toDataURL('image/jpeg', 0.8);
            closeModal();
            renderImages();
        }

        function removeCurrentImage() {
            imageData = imageData.filter(i => i.id !== currentId);
            closeModal();
            renderImages();
            if(imageData.length === 0) {
                emptyState.classList.remove('hidden');
                convertBtn.classList.add('hidden');
            }
        }

        function closeModal() { document.getElementById('editModal').classList.add('hidden'); }

        convertBtn.onclick = async () => {
            convertBtn.innerText = "Processing...";
            const formData = new FormData();
            for(let i=0; i < imageData.length; i++) {
                const res = await fetch(imageData[i].src);
                const blob = await res.blob();
                formData.append('images', blob, `img${i}.jpg`);
            }

            const response = await fetch('https://imgtopdf1.onrender.com/convert-to-pdf', { method: 'POST', body: formData });
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            
            document.getElementById('pdfFrame').src = url;
            document.getElementById('downloadBtn').href = url;
            document.getElementById('downloadBtn').download = "Pro_Converted.pdf";
            document.getElementById('pdfModal').classList.remove('hidden');
            convertBtn.innerText = "Generate PDF";
        };
    </script>
</body>
</html>
